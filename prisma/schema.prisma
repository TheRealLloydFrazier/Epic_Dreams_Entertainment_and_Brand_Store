generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters", "multiSchema"]

}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas  = ["public", "neon_auth"]
}

enum DiscountType {
  percentage
  fixed
}

enum OrderStatus {
  Pending
  Paid
  Packed
  Shipped
  Delivered
  Refunded
}

model Product {
  artists    ProductArtist[]
  id          Int              @id @default(autoincrement())
  title       String
  slug        String            @unique
  description String
  featured    Boolean           @default(false)
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  variants    ProductVariant[]
  images      ProductImage[]
  collections CollectionProduct[]
}

model ProductVariant {
  id             Int       @id @default(autoincrement())
  product        Product   @relation(fields: [productId], references: [id])
  productId      Int
  name           String
  sku            String    @unique
  priceCents     Int       @map("price_cents")
  compareAtCents Int?      @map("compare_at_cents")
  signed         Boolean   @default(false)
  inventory      Int       @default(0)
  attributes     Json?
  orderItems     OrderItem[]
}

model ProductImage {
  id         Int     @id @default(autoincrement())
  product    Product @relation(fields: [productId], references: [id])
  productId  Int
  url        String
  sortOrder  Int     @default(0) @map("sort_order")
}

model Collection {
  id        Int       @id @default(autoincrement())
  title     String
  slug      String    @unique
  rule      Json?
  products  CollectionProduct[]
}

model CollectionProduct {
  collection   Collection @relation(fields: [collectionId], references: [id])
  collectionId Int
  product      Product    @relation(fields: [productId], references: [id])
  productId    Int

  @@id([collectionId, productId])
}

model Order {
  id                     Int          @id @default(autoincrement())
  email                  String
  totalCents             Int          @map("total_cents")
  currency               String       @default("usd")
  status                 OrderStatus  @default(Pending)
  stripePaymentIntentId  String?      @map("stripe_payment_intent_id")
  stripeCheckoutSessionId String?     @map("stripe_checkout_session_id")
  shippingAddress        Json?        @map("shipping_address")
  billingAddress         Json?        @map("billing_address")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")
  items                  OrderItem[]
  trackingNumber         String?
}

model OrderItem {
  id             Int            @id @default(autoincrement())
  order          Order          @relation(fields: [orderId], references: [id])
  orderId        Int
  variant        ProductVariant @relation(fields: [productVariantId], references: [id])
  productVariantId Int          @map("product_variant_id")
  title          String
  sku            String
  quantity       Int
  priceCents     Int            @map("price_cents")
}

model Discount {
  id         Int          @id @default(autoincrement())
  code       String       @unique
  type       DiscountType
  value      Int
  startsAt   DateTime?    @map("starts_at")
  endsAt     DateTime?    @map("ends_at")
  usageLimit Int?         @map("usage_limit")
  timesUsed  Int          @default(0) @map("times_used")
}

model Artist {
  products  ProductArtist[]
  id        Int      @id @default(autoincrement())
  name      String
  slug      String   @unique
  bio       String
  socials   Json?
  heroImage String?  @map("hero_image")
  releases  Release[]
}

model Release {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  releaseDate DateTime @map("release_date")
  coverImage  String?  @map("cover_image")
  tracks      Json?
  links       Json?
  artist      Artist   @relation(fields: [artistId], references: [id])
  artistId    Int
}

model Post {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  excerpt     String?
  content     String
  heroImage   String?  @map("hero_image")
  publishedAt DateTime? @map("published_at")
  seo         Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
}

model Setting {
  key   String @id
  value Json?
}

model FileAsset {
  id        Int      @id @default(autoincrement())
  filename  String
  url       String
  createdAt DateTime @default(now()) @map("created_at")
}

model AdminUser {
  id              Int      @id @default(autoincrement())
  email           String   @unique
  passwordHash    String   @map("password_hash")
  role            String   @default("admin")
  mustChangePassword Boolean @default(true) @map("must_change_password")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  sessions        AdminSession[]
}

model AdminSession {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      AdminUser @relation(fields: [userId], references: [id])
  userId    Int
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
}


model ProductArtist {
  product   Product @relation(fields: [productId], references: [id])
  productId Int
  artist    Artist  @relation(fields: [artistId], references: [id])
  artistId  Int

  @@id([productId, artistId])
}

// Epic Dreams Organization Structure
enum CompanyType {
  holding
  subsidiary
}

enum CompanyStatus {
  active
  inactive
  planned
}

model Company {
  id            Int           @id @default(autoincrement())
  name          String
  legalName     String        @map("legal_name")
  slug          String        @unique
  type          CompanyType
  status        CompanyStatus @default(active)
  description   String?
  mission       String?
  vision        String?
  logoUrl       String?       @map("logo_url")
  website       String?
  email         String?
  phone         String?
  address       Json?
  socials       Json?
  foundedDate   DateTime?     @map("founded_date")
  parentId      Int?          @map("parent_id")
  parent        Company?      @relation("CompanyHierarchy", fields: [parentId], references: [id])
  subsidiaries  Company[]     @relation("CompanyHierarchy")
  sortOrder     Int           @default(0) @map("sort_order")
  metadata      Json?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
}
